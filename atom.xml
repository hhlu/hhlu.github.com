<?xml version="1.0" encoding="utf-8"?>
<feed xml:lang="en-US" xmlns="http://www.w3.org/2005/Atom">
    <title>howardlu.com</title>
    <link href="http://howardlu.com/atom.xml" rel="self" />
    <link href="http://howardlu.com" />
    <updated>2013-09-04T20:02:39-07:00</updated>
    <id>http://howardlu.com/</id>
    <author>
        <name>Howard Lu</name>
    </author>

    <entry>
        <title>Getting Started With Vagrant And Puppet</title>
        <link href="http://howardlu.com/2013/09/02/getting-started-with-vagrant-and-puppet/" />
        <updated>2013-09-02T00:00:00-07:00</updated>
        <id>http://howardlu.com/2013/09/02/getting-started-with-vagrant-and-puppet</id>
        <content type="html">&lt;p&gt;Vagrant is an application allowing easy creation and management of virtual machines, and Puppet is a system configuration tool that works with it.&lt;/p&gt;

&lt;p&gt;At my workplace, we use both of these to streamline our development processâ€”you can be sure everyone is working in the same environment, and if anyone new needs to be brought onto a project, all they need to do is run a single command to get started. This can be further extended to a production environment where Puppet scripts can serve as a version-controlled source of documentation for how any given server is configured.&lt;/p&gt;

&lt;p&gt;While these tools certainly work well in a larger team environment, I find them quite useful personally as well. I think most people have some sort of personal file backup nowadays, that doesn&amp;#8217;t save you from the inconvenience of re-installing all your applications and re-configuring your system settings should your computer have a critical failure. If that machine just happened to be one used for development as well, manually trying to get all your dependencies back to how they are supposed to be can be a huge pain. These tools solve this issue.&lt;/p&gt;

&lt;p&gt;Since I&amp;#8217;d created a Vagrant setup for developing this website, I figured going over the basics of it would be a good article to start with.&lt;/p&gt;

&lt;p&gt;You&amp;#8217;ll need to install the necessary software to get started: Vagrant and a virtualization provider. Vagrant comes with out-of-the-box support for &lt;a href='https://www.virtualbox.org/' target='_blank'&gt;VirtualBox&lt;/a&gt; so I&amp;#8217;ll be talking about that, although you&amp;#8217;re free to experiment with &lt;a href='http://docs.vagrantup.com/v2/providers/index.html' target='_blank'&gt;other providers&lt;/a&gt; as well.&lt;/p&gt;

&lt;p&gt;VirtualBox 4.2.* and Vagrant 1.2.* are the latest versions at the time of writing and can be downloaded at the following links:&lt;/p&gt;
&lt;ul&gt;
    &lt;li&gt;&lt;a href='https://www.virtualbox.org/wiki/Downloads' target='_blank'&gt;https://www.virtualbox.org/wiki/Downloads&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href='http://downloads.vagrantup.com/' target='_blank'&gt;http://downloads.vagrantup.com/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id='creating_a_vagrant_project'&gt;Creating a Vagrant Project&lt;/h2&gt;

&lt;p&gt;The first step is to create an empty directory and then initialize it with Vagrant.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir vagrant_vm &amp;amp;&amp;amp; cd vagrant_vm
vagrant init&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A &lt;code&gt;Vagrantfile&lt;/code&gt; will be generated inside the directory you just created. This contains the configuration Vagrant will use to determine how to set up your virtual machine. You&amp;#8217;ll see long blocks of text upon opening the file and this may be somewhat intimidating. However, but most of it are commented explanations examples. For reference, the file uses Ruby syntax but experience with the language shouldn&amp;#8217;t be needed.&lt;/p&gt;

&lt;p&gt;I&amp;#8217;ll only be covering how to do a basic setup but those inclined to look further can check out the &lt;a href='http://docs.vagrantup.com/v2/' target='_blank'&gt;official documentation&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id='configuring_vagrantfile'&gt;Configuring Vagrantfile&lt;/h2&gt;

&lt;p&gt;All the configuration in &lt;code&gt;Vagrantfile&lt;/code&gt; is set up within a Ruby block between the &lt;code&gt;Vagrant.configure(&amp;quot;2&amp;quot;) do |config|&lt;/code&gt; near the top the &lt;code&gt;end&lt;/code&gt; at the bottom. The most important line you need to change is &lt;code&gt;config.vm.box = &amp;quot;base&amp;quot;&lt;/code&gt;. This tells Vagrant which base box to load up before configuring the machine. Base boxes are basically VMs that have been packaged for reuse. You can create your own from a VirtualBox VM using the &lt;a href='http://docs.vagrantup.com/v2/cli/package.html' target='_blank'&gt;vagrant package&lt;/a&gt; command, but I will be using the Ubuntu 12.04 64-bit box provided by Vagrant. There is a long list of &lt;a href='http://www.vagrantbox.es/' target='_blank'&gt;other available boxes&lt;/a&gt; as well.&lt;/p&gt;

&lt;p&gt;In order to make a base box available to Vagrant, you must first add it using the &lt;code&gt;vagrant add&lt;/code&gt; command. The syntax is &lt;code&gt;vagrant box add box_name box_url&lt;/code&gt;, where &lt;code&gt;box_name&lt;/code&gt; can be anything you want and &lt;code&gt;box_url&lt;/code&gt; is where the base box can be downloaded. For example, you can use the following to download the Ubuntu box I mentioned earlier:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vagrant box add precise64 http://files.vagrantup.com/precise64.box&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After the download finishes, you can change the &lt;code&gt;config.vm.box = &amp;quot;base&amp;quot;&lt;/code&gt; line we saw earlier into &lt;code&gt;config.vm.box = &amp;quot;precise64&amp;quot;&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Now you essentially have a bare bones Vagrant VM. Executing &lt;code&gt;vagrant up&lt;/code&gt; should start up the machine and you can SSH into it with &lt;code&gt;vagrant ssh&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id='provisioning_with_puppet'&gt;Provisioning with Puppet&lt;/h2&gt;

&lt;p&gt;While you have a basic Vagrant VM now, it&amp;#8217;s not much use without some personal configuration. This is where Puppet comes in. Further down in your Vagrantfile, you will see a commented block of code similar to the following:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# config.vm.provision :puppet do |puppet|
#   puppet.manifests_path = &amp;quot;manifests&amp;quot;
#   puppet.manifest_file  = &amp;quot;init.pp&amp;quot;
# end&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This tells Vagrant to configure the VM with Puppet using a file called &lt;code&gt;init.pp&lt;/code&gt; in the &lt;code&gt;manifests&lt;/code&gt; folder. Note that all paths are relative to where your Vagrantfile is located. &lt;a href='http://docs.puppetlabs.com/puppet/3/reference/index.html' target='_blank'&gt;Puppet&lt;/a&gt; is quite an extensive product which you could easily tell by the length of its documentation so you&amp;#8217;ll likely want to dig further into it outside of this article.&lt;/p&gt;

&lt;p&gt;First, you&amp;#8217;ll want to uncomment the block shown above. Then, add &lt;code&gt;puppet.module_path = &amp;quot;modules&amp;quot;&lt;/code&gt; somewhere in that block to end up with the following:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;config.vm.provision :puppet do |puppet|
    puppet.manifests_path = &amp;quot;manifests&amp;quot;
    puppet.manifest_file = &amp;quot;init.pp&amp;quot;

    puppet.module_path = &amp;quot;modules&amp;quot;
end&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;While you can technically put all your Puppet configuration in &lt;code&gt;manifests/init.pp&lt;/code&gt;, this goes against Puppet best practices where all custom code should be defined in modules.&lt;/p&gt;

&lt;p&gt;We&amp;#8217;ll need to create several files and directories now as demonstrated by the below commands. I will be creating a module called &lt;code&gt;git&lt;/code&gt; for this article.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir manifests
touch manifests/init.pp

mkdir modules
modules/git
modules/git/manifests
touch modules/git/manifests/init.pp&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I won&amp;#8217;t go into detail why these steps are needed, but know this is the most basic configuration required for a Puppet module to work. However, do check out the &lt;a href='http://docs.puppetlabs.com/puppet/3/reference/modules_fundamentals.html#module-layout' target='_blank'&gt;documentation&lt;/a&gt; for a full description of how modules are laid out.&lt;/p&gt;

&lt;p&gt;In the end, you should have a directory tree like the this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;|-- Vagrantfile
|-- manifests
    |-- init.pp
|-- modules
    |-- git
        |-- manifests
            |-- init.pp&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Open up your &lt;code&gt;modules/git/manifests/init.pp&lt;/code&gt; for editing. This file must contain the module&amp;#8217;s main class definition with the class name exactly equalling the module name. For our class, it would need this at minimum:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;class git {
    # do something here
}&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Since our module is called &lt;code&gt;git&lt;/code&gt;, let&amp;#8217;s install git by updating the file:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;class git {
    package { &amp;#39;git&amp;#39;:
        ensure =&amp;gt; present
    }
}&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You&amp;#8217;ll want to look at the reference manual for Puppet syntax, but the above will tell Puppet to ensure the &lt;code&gt;git&lt;/code&gt; package is installed on your system. Puppet is smart enough to know which package manager to use for the operating system (apt in our case), but you could do the following to be safe:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;class git {
    package { &amp;#39;git&amp;#39;:
        ensure =&amp;gt; present,
        provider =&amp;gt; apt
    }
}&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You may also want to update your sources list before trying to install git:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;class git {
    exec { &amp;#39;apt-update&amp;#39;:
        command =&amp;gt; &amp;#39;/usr/bin/apt-get update&amp;#39;
    }

    package { &amp;#39;git&amp;#39;:
        ensure =&amp;gt; present,
        provider =&amp;gt; apt,
        require =&amp;gt; Exec[&amp;#39;apt-update&amp;#39;]
    }
}&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The file looks ok at this point, but you still need to tell Puppet to use this module. In &lt;code&gt;modules/init.pp&lt;/code&gt;, add the following:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;node default {
    include git
}&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now you&amp;#8217;re done. In the directory where your &lt;code&gt;Vagrantfile&lt;/code&gt; is located, run &lt;code&gt;vagrant reload&lt;/code&gt; which will shutdown your VM, restart it, and apply all the configurations. Note that &lt;code&gt;vagrant provision&lt;/code&gt; can normally apply configurations to a VM while it is current running, but since the &lt;code&gt;manifests&lt;/code&gt; and &lt;code&gt;modules&lt;/code&gt; directory did not exist when you first ran &lt;code&gt;vagrant up&lt;/code&gt;, you need to reload the VM in order for the new directories to get mounted.&lt;/p&gt;

&lt;p&gt;First start after a configuration update might take a while, but your output should look something like this in the end:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[default] Attempting graceful shutdown of VM...
[default] Setting the name of the VM...
[default] Clearing any previously set forwarded ports...
[default] Creating shared folders metadata...
[default] Clearing any previously set network interfaces...
[default] Preparing network interfaces based on configuration...
[default] Forwarding ports...
[default] -- 22 =&amp;gt; 2222 (adapter 1)
[default] Booting VM...
[default] Waiting for VM to boot. This can take a few minutes.
[default] VM booted and ready for use!
[default] Mounting shared folders...
[default] -- /vagrant
[default] -- /tmp/vagrant-puppet/manifests
[default] -- /tmp/vagrant-puppet/modules-0
[default] Running provisioner: puppet...
Running Puppet with init.pp...
stdin: is not a tty
notice: /Stage[main]/Git/Exec[apt-update]/returns: executed successfully
notice: /Stage[main]/Git/Package[git]/ensure: created
notice: Finished catalog run in 364.25 seconds&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you SSH into your VM again, the &lt;code&gt;git&lt;/code&gt; command should now be available.&lt;/p&gt;

&lt;p&gt;What&amp;#8217;s nice is that if you ever decide you want to use your Puppet scripts without Vagrant, for example on a local machine, you can do so:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;puppet apply --modulepath modules manifests/init.pp&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You&amp;#8217;ll need to have Puppet installed where you run this.&lt;/p&gt;

&lt;h2 id='final_words'&gt;Final Words&lt;/h2&gt;

&lt;p&gt;I hope this article gave an understandable introduction to these powerful system management tools, and those interested should definitely study the reference manuals at &lt;a href='http://docs.vagrantup.com/v2/' target='_blank'&gt;http://docs.vagrantup.com/v2/&lt;/a&gt; and &lt;a href='http://docs.puppetlabs.com/puppet/3/reference/' target='_blank'&gt;http://docs.puppetlabs.com/puppet/3/reference/&lt;/a&gt; to learn more.&lt;/p&gt;

&lt;p&gt;My Jekyll VM is available on GitHub at &lt;a href='https://github.com/hhlu/vagrant-jekyll' target='_blank'&gt;https://github.com/hhlu/vagrant-jekyll&lt;/a&gt; as well for a more complex example. Feel free to leave a comment for any additional explanations or if anything was unclear.&lt;/p&gt;</content>
    </entry>
</feed>
